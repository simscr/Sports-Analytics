coord_polar(start = pi, direction = 1) +
#    lims(y = c(-10, 30)) +
theme_void()
comb_plot <- sonar_plot + point_plot +
plot_annotation(title = player_name,
subtitle = "Barcelona, 2019-2020",
caption = "Data provided by StatsBomb")
# return(list(sonar_plot = sonar_plot,
#             point_plot = point_plot + labs(title = player_name),
#             comb_plot = comb_plot))
#plot_name <- paste0("p_", player_name)
player_name <- player_name
p <- point_plot + labs(title = player_name)
label(player_name) <<- p
}
passing_plots_v2("Frenkie de Jong")
reduce(list(map(players, ~passing_plots_v2(.))), "+") + plot_layout(design = formation)
passing_plots_v2 <- function(player_name){
df1 <- barca_sonar %>%
filter(str_detect(player.name, player_name))
sonar_plot <- df1 %>%
ggplot() +
geom_hline(yintercept = seq(0, 30, 5), color = "gray") +
annotate(geom = "text", x = 0, y = seq(0, 30, 5), label = seq(0, 30, 5), color = "gray") +
geom_bar(aes(x=angle.round, y=pct.angle, fill=distance), stat="identity") +
#    scale_y_continuous(limits=c(-10, 30)) +
scale_x_continuous(breaks=seq(-180,180, by=90), limits=c(-180,180)) +
coord_polar(start=pi, direction=1) +
scale_fill_gradient("Distance (yards)",
high = "#DB0030",
low = "#FFED02") +
labs(x='', y='')+
theme_void() +
theme(plot.title = element_text(hjust=0.5),
legend.position = "none", #uncomment to remove colorbar
plot.background = element_rect(fill = "transparent",colour = NA),
panel.background = element_rect(fill = "transparent",colour = NA))
df2 <- barca_sum %>%
filter(str_detect(player.name, player_name))
point_plot <- df2 %>%
ggplot(aes(pass_angle, pass_length)) +
geom_hline(yintercept = seq(0, 30, 5), color = "gray") +
annotate(geom = "text", x = 0, y = seq(0, 30, 5), label = seq(0, 30, 5), color = "gray") +
geom_point(alpha = 0.8, fill = "#004D98", shape = 21, color = "white") +
geom_segment( aes(x=pass_angle, xend=pass_angle, y=0, yend=pass_length), alpha = 0.05, color = "#004D98") +
coord_polar(start = pi, direction = 1) +
#    lims(y = c(-10, 30)) +
theme_void()
comb_plot <- sonar_plot + point_plot +
plot_annotation(title = player_name,
subtitle = "Barcelona, 2019-2020",
caption = "Data provided by StatsBomb")
# return(list(sonar_plot = sonar_plot,
#             point_plot = point_plot + labs(title = player_name),
#             comb_plot = comb_plot))
return(point_plot + labs(title = player_name))
}
reduce(list(map(players, ~passing_plots_v2(.))), "+") + plot_layout(design = formation)
reduce(list(map(players, ~passing_plots_v2(.))), "+")
point_plots <- #lapply(players, passing_plots_v2)
list(map(players, ~passing_plots_v2(.))
reduce(), "+") + plot_layout(design = formation)
point_plots <- #lapply(players, passing_plots_v2)
list(map(players, ~passing_plots_v2(.)))
View(point_plots)
point_plots[[1]][[1]]
reduce(point_plots[[1]], "+)"
reduce(point_plots[[1]], "+")
reduce(point_plots[[1]][[1:11]], "+")
reduce(point_plots[[1]][[1:n]], "+")
point_plots[[1]]
names(point_plots[[1]]) <- players
point_plots[[1]]$`Lionel AndrÃ©s Messi Cuccittini`
point_plots <- list(map(players, ~passing_plots_v2(.))) %>%
set_names(players)
point_plots <- list(map(players, ~passing_plots_v2(.))) %>%
unnest() %>%
set_names(players)
point_plots <- list(map(players, ~passing_plots_v2(.))) %>%
unlist() %>%
set_names(players)
point_plots <- list(map(players, ~passing_plots_v2(.))) %>%
unlist()
View(point_plots)
point_plots <- list(map(players, ~passing_plots_v2(.))) %>%
unnest()
point_plots <- list(map(players, ~passing_plots_v2(.))) %>%
unlist(recursive = F)
View(point_plots)
point_plots <- list(map(players, ~passing_plots_v2(.))) %>%
unlist(recursive = F) %>%
set_names(players)
View(point_plots)
reduce(point_plots, "+")
point_plots + plot_layout(design = formation)
wrap_plots(point_plots)
wrap_plots(point_plots) + plot_layout(design = formation)
wrap_plots(point_plots) + plot_layout(design = formation, byrow = F)
formation <- "
##1##
2###3
#4#5#
##6##
78#910
##11##
"
wrap_plots(point_plots) + plot_layout(design = formation, byrow = F)
formation <- "
##1###
2###3#
#4#5##
##6###
78#910
##11##
"
wrap_plots(point_plots) + plot_layout(design = formation, byrow = F)
formation <- c(
area(3, 1),  # ST
area(2, 1),  # LW
area(2, 5),  # RW
area(3, 2),  # LCM
area(3, 4),  # RCM
area(4, 3),  # CDM
area(5, 1),  # LB
area(5, 2),  # LCB
area(5, 4),  # RCB
area(5, 5),  # RB
area(6, 3),  # GK
)
formation <- c(
area(3, 1),  # ST
area(2, 1),  # LW
area(2, 5),  # RW
area(3, 2),  # LCM
area(3, 4),  # RCM
area(4, 3),  # CDM
area(5, 1),  # LB
area(5, 2),  # LCB
area(5, 4),  # RCB
area(5, 5),  # RB
area(6, 3)  # GK
)
wrap_plots(point_plots) + plot_layout(design = formation)
formation <- c(
area(1, 3),  # ST
area(2, 1),  # LW
area(2, 5),  # RW
area(3, 2),  # LCM
area(3, 4),  # RCM
area(4, 3),  # CDM
area(5, 1),  # LB
area(5, 2),  # LCB
area(5, 4),  # RCB
area(5, 5),  # RB
area(6, 3)  # GK
)
wrap_plots(point_plots) + plot_layout(design = formation)
View(barca_raw)
test <- barca_raw %>% filter(!is.na(tactics.lineup))
View(test)
View(test[[24]][[11]])
test <- barca_raw %>% filter(is.na(position.name))
View(test[[24]][[25]])
View(test)
View(barca_raw[[24]][[6]])
View(barca_raw[[24]][[22]])
players <- rev(c(barca_raw[[24]][[22]]$player.name))
View(barca_raw)
View(barca_raw[[24]][[46650]])
players <- rev(c(barca_raw[[24]][[46650]]$player.name))
point_plots <- list(map(players, ~passing_plots_v2(.))) %>%
unlist(recursive = F) %>%
set_names(players)
wrap_plots(point_plots) + plot_layout(design = formation)
knitr::opts_chunk$set(
warning = FALSE,
message = FALSE,
echo = FALSE,
fig.retina = 3,
fig.path = here::here("exports", "MLB", "Plots", "/")
)
pacman::p_load(pacman, tidyverse, janitor, here, rio, job, skimr)
theme_set(theme_bw(base_size = 15))
p_load(Lahman, pitchRx, retrosheet, openWAR, baseballr, teamcolors, zoo)
playerid_lookup("Trout")
trout_id <- playerid_lookup("Trout")
View(trout_id)
trout_id <- playerid_lookup("Trout") %>%
filter(first_name == "Mike") %>%
select(mlbam_id, first_name, last_name)
View(trout_id)
hit_sum <- function(df){
df  %>%
select(game_date, events, home_team, away_team) %>%
filter(!is.na(events)) %>%
group_by(game_date) %>%
mutate(hits = sum(events %in% c("single", "double", "triple", "home_run")),
pa = sum(!is.na(events == T)),
ab = pa - sum(events %in% c("hit_by_pitch", "sac_fly", "walk")),
game_avg = hits/ab) %>%
ungroup() %>%
arrange(game_date) %>%
group_by(isna = is.na(game_avg)) %>%
mutate(avg = ifelse(isna, NA, round(cummean(game_avg), 3))) %>%
#    group_by(game_date) %>%
mutate(avg_25_ab = rollmean(avg, k = 25, fill = NA))
}
mlb_colors <- teamcolors %>%
select(name, league, primary, secondary, tertiary, quaternary) %>%
filter(league == "mlb") %>%
mutate(team_abbr = case_when(name == "Arizona Diamondbacks" ~ "AZ",
name == "Atlanta Braves" ~ "ATL",
name == "Baltimore Orioles" ~ "BAL",
name == "Boston Red Sox" ~ "BOS",
name == "Chicago Cubs" ~ "CHC",
name == "Chicago White Sox" ~ "CWS",
name == "Cincinnati Reds" ~ "CIN",
name == "Cleveland Indians" ~ "CLE",
name == "Colorado Rockies" ~ "COL",
name == "Detroit Tigers" ~ "DET",
name == "Houston Astros" ~ "HOU",
name == "Kansas City Royals" ~ "KC",
name == "Los Angeles Angels" ~ "LAA",
name == "Los Angeles Dodgers" ~ "LAD",
name == "Miami Marlins" ~ "MIA",
name == "Milwaukee Brewers" ~ "MIL",
name == "Minnesota Twins" ~ "MIN",
name == "New York Mets" ~ "NYM",
name == "New York Yankees" ~ "NYY",
name == "Oakland Athletics" ~ "OAK",
name == "Philadelphia Phillies" ~ "PHI",
name == "Pittsburgh Pirates" ~ "PIT",
name == "San Diego Padres" ~ "SD",
name == "San Francisco Giants" ~ "SF",
name == "Seattle Mariners" ~ "SEA",
name == "St. Louis Cardinals" ~ "STL",
name == "Tampa Bay Rays" ~ "TB",
name == "Texas Rangers" ~ "TEX",
name == "Toronto Blue Jays" ~ "TOR",
name == "Washington Nationals" ~ "WSH")
)
trout_stats<- scrape_statcast_savant(start_date = "2011-07-08", end_date = Sys.Date()-1,
playerid = trout_id[1, 1], player_type = "batter")
skim(trout_stats)
trout_stats<- scrape_statcast_savant(start_date = "2019-03-28", end_date = "2019-09-29",
playerid = trout_id[1, 1], player_type = "batter")
skim(trout_stats)
skim(trout_stats)
View(trout_stats)
find("scrape_statcast_savant")
names(trout_stats)
predictors <- c("release_speed", "effective_speed", "release_spin_rate", "pfx_x", "pfx_z")
outcomes <- c("events")
test <- trout_stats %>%
select(colnames %in% predictors | outcomes)
test <- trout_stats %>%
select(matches(predictors | outcomes))
test <- trout_stats %>%
select(matches(predictors) | matches(outcomes))
head(test, 20)
trout_sm <- trout_stats %>%
select(matches(predictors) | matches(outcomes))
trout_sm %>%
ggplot(aes(release_speed, effective_speed)) +
geom_point() +
stat_cor()
pacman::p_load(ggpubr, pacman, tidyverse, janitor, here, rio, job, skimr)
trout_sm %>%
ggplot(aes(release_speed, effective_speed)) +
geom_point() +
stat_cor()
View(mlb_colors)
trout_sm %>%
ggplot(aes(release_speed, effective_speed)) +
geom_point(alpha = 0.3, shape = 1) +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#ba0021")
trout_sm %>%
ggplot(aes(release_speed, effective_speed)) +
geom_point(alpha = 0.3, shape = 21, fill = "#003263") +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#ba0021")
trout_sm %>%
ggplot(aes(release_speed, effective_speed)) +
geom_point(alpha = 0.3, shape = 1, color = "#003263") +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#ba0021")
trout_sm %>%
ggplot(aes(release_speed, release_spin_rate)) +
geom_point(alpha = 0.3, shape = 1, color = "#003263") +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#ba0021")
predictors <- c("pitch_type", "release_speed", "effective_speed", "release_spin_rate", "pfx_x", "pfx_z")
outcomes <- c("events")
trout_sm <- trout_stats %>%
select(matches(predictors) | matches(outcomes))
trout_sm %>%
ggplot(aes(release_speed, release_spin_rate)) +
geom_point(alpha = 0.3, shape = 1, aes(color = pitch_type)) +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#ba0021")
trout_sm %>%
ggplot(aes(release_speed, release_spin_rate)) +
geom_point(shape = 1, aes(color = pitch_type)) +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#ba0021")
count(trout_sm, pitch_type)
trout_sm <- trout_stats %>%
select(matches(predictors) | matches(outcomes)) %>%
mutate(pitch_cat = case_when(pitch_type %in% c("FA", "FF", "FC", "FS", "FT") ~ "Fastball",
TRUE ~ "Off-Speed"))
trout_sm %>%
ggplot(aes(release_speed, release_spin_rate)) +
geom_point(shape = 1, aes(color = pitch_cat)) +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#ba0021")
pacman::p_load(ggpubr, pacman, tidyverse, janitor, here, rio, job, skimr, paletteer)
paletteer_d("nbapalettes::warriors_city")
trout_sm %>%
ggplot(aes(release_speed, release_spin_rate)) +
geom_point(shape = 1, aes(color = pitch_cat)) +
scale_color_paletteer_d("nbapalettes::warriors_city") +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#ba0021")
trout_sm %>%
ggplot(aes(release_speed, release_spin_rate)) +
geom_point(shape = 1, aes(color = pitch_cat)) +
scale_color_paletteer_d("nbapalettes::warriors_city") +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#FFA400F")
trout_sm %>%
ggplot(aes(release_speed, release_spin_rate)) +
geom_point(shape = 1, aes(color = pitch_cat)) +
scale_color_paletteer_d("nbapalettes::warriors_city") +
stat_cor() +
geom_smooth(method = "lm", se = F, color = "#FFA400FF")
pacman::p_load(ggpubr, pacman, tidyverse, janitor, here, rio, job, skimr, paletteer, broom)
trout_pca <- trout_sm %>%
mutate(across(where(is.numeric), scale))
View(trout_pca)
pca_fit <- trout_sm %>%
select(where(is.numeric)) %>%
prcomp(scale = T)
View(trout_pca)
names(trout_sm)
trout_pca <- trout_sm %>%
mutate(across(where(is.numeric), scale)) %>%
drop_na(2:6)
pca_fit <- trout_pca %>%
select(where(is.numeric)) %>%
prcomp()
pca_fit %>%
augment(trout_pca)
trout_pca_results <- pca_fit %>%
augment(trout_pca)
View(trout_pca_results)
trout_sm <- trout_stats %>%
select(matches(predictors) | matches(outcomes)) %>%
mutate(pitch_cat = case_when(pitch_type %in% c("FA", "FF", "FC", "FS", "FT") ~ "Fastball",
TRUE ~ "Off-Speed"),
ab_result = case_when(events %in% c("single", "double", "triple", "home_run") ~ "Hit",
events %in% c("hit_by_pitch", "sac_fly", "walk") ~ "BB/HBP/SF",
is.na(events) ~ NA_character_,
TRUE ~ "Out"))
trout_pca <- trout_sm %>%
mutate(across(where(is.numeric), scale)) %>%
drop_na(2:6)
pca_fit <- trout_pca %>%
select(where(is.numeric)) %>%
prcomp()
trout_pca_results <- pca_fit %>%
augment(trout_pca)
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, color = ab_result)) +
geom_point(size = 1.5)
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, color = pitch_cat)) +
geom_point(size = 1.5)
trout_pca <- trout_sm %>%
mutate(across(where(is.numeric), scale)) %>%
select(-effective_speed) %>%
drop_na(2:6)
pca_fit <- trout_pca %>%
select(where(is.numeric)) %>%
prcomp()
trout_pca_results <- pca_fit %>%
augment(trout_pca)
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, color = pitch_cat)) +
geom_point(size = 1.5)
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, color = ab_result)) +
geom_point(size = 1.5)
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, color = ab_result)) +
geom_point(size = 1.5) +
scale_fill_paletteer_d("awtools::ppalette")
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, fill = ab_result)) +
geom_point(size = 1.5, shape = 21) +
scale_fill_paletteer_d("awtools::ppalette")
pca_fit %>%
tidy(matrix = "eigenvalues") %>%
ggplot(aes(PC, percent)) +
geom_col(fill = "#56B4E9", alpha = 0.8) +
scale_x_continuous(breaks = 1:9) +
scale_y_continuous(
labels = scales::percent_format(),
expand = expansion(mult = c(0, 0.01))
)
pca_fit %>%
tidy(matrix = "rotation") %>%
pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") %>%
ggplot(aes(PC1, PC2)) +
geom_segment(xend = 0, yend = 0, arrow = arrow_style) +
geom_text(
aes(label = column),
hjust = 1, nudge_x = -0.02,
color = "#904C2F"
) +
xlim(-1.25, .5) + ylim(-.5, 1) +
coord_fixed()
pca_fit %>%
tidy(matrix = "rotation") %>%
pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") %>%
ggplot(aes(PC1, PC2)) +
geom_segment(xend = 0, yend = 0, arrow = 1) +
geom_text(
aes(label = column),
hjust = 1, nudge_x = -0.02,
color = "#904C2F"
) +
xlim(-1.25, .5) + ylim(-.5, 1) +
coord_fixed()
pca_fit %>%
tidy(matrix = "rotation") %>%
pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") %>%
ggplot(aes(PC1, PC2)) +
geom_segment(xend = 0, yend = 0) +
geom_text(
aes(label = column),
hjust = 1, nudge_x = -0.02,
color = "#904C2F"
) +
xlim(-1.25, .5) + ylim(-.5, 1) +
coord_fixed()
arrow_style <- arrow(
angle = 20, ends = "first", type = "closed", length = grid::unit(8, "pt")
)
pca_fit %>%
tidy(matrix = "rotation") %>%
pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") %>%
ggplot(aes(PC1, PC2)) +
geom_segment(xend = 0, yend = 0, arrow = arrow_style) +
geom_text(
aes(label = column),
hjust = 1, nudge_x = -0.02,
color = "#904C2F"
) +
xlim(-1.25, .5) + ylim(-.5, 1) +
coord_fixed()
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, fill = pitch_type)) +
geom_point(size = 1.5, shape = 21) +
scale_fill_paletteer_d("awtools::ppalette")
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, fill = pitch_cat)) +
geom_point(size = 1.5, shape = 21) +
scale_fill_paletteer_d("awtools::ppalette")
trout_pca_results %>%
ggplot(aes(.fittedPC1, .fittedPC2, fill = events)) +
geom_point(size = 1.5, shape = 21) +
scale_fill_paletteer_d("awtools::ppalette")
pca_fit2 <- trout_pca %>%
filter(ab_result == "Hit") %>%
select(where(is.numeric)) %>%
prcomp()
trout_pca_results2 <- pca_fit2 %>%
augment(trout_pca %>% filter(ab_result == "Hit"))
trout_pca_results2 %>%
ggplot(aes(.fittedPC1, .fittedPC2, fill = events)) +
geom_point(size = 1.5, shape = 21) +
scale_fill_paletteer_d("awtools::ppalette")
trout_pca_results2 %>%
ggplot(aes(.fittedPC1, .fittedPC2, fill = ab_result)) +
geom_point(size = 1.5, shape = 21) +
scale_fill_paletteer_d("awtools::ppalette")
trout_pca_results2 %>%
ggplot(aes(.fittedPC1, .fittedPC2, fill = pitch_cat)) +
geom_point(size = 1.5, shape = 21) +
scale_fill_paletteer_d("awtools::ppalette")
pca_fit2 %>%
tidy(matrix = "rotation") %>%
pivot_wider(names_from = "PC", names_prefix = "PC", values_from = "value") %>%
ggplot(aes(PC1, PC2)) +
geom_segment(xend = 0, yend = 0, arrow = arrow_style) +
geom_text(
aes(label = column),
hjust = 1, nudge_x = -0.02,
color = "#904C2F"
) +
xlim(-1.25, .5) + ylim(-.5, 1) +
coord_fixed()
pca_fit2 %>%
tidy(matrix = "eigenvalues") %>%
ggplot(aes(PC, percent)) +
geom_col(fill = "#56B4E9", alpha = 0.8) +
scale_x_continuous(breaks = 1:9) +
scale_y_continuous(
labels = scales::percent_format(),
expand = expansion(mult = c(0, 0.01))
)
